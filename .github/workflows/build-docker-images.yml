name: Build OpenAvatarChat AMD64 (Complete)

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  IMAGE_NAME: openavatar-chat-complete
  IMAGE_TAG: latest

jobs:
  build-complete:
    runs-on: ubuntu-latest  # ä½¿ç”¨AMD64è¿è¡Œå™¨
    timeout-minutes: 480  # 8å°æ—¶è¶…æ—¶
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build complete OpenAvatarChat image
        run: |
          echo "ðŸš€ å¼€å§‹æž„å»ºå®Œæ•´çš„OpenAvatarChat ARM64é•œåƒ..."
          docker build \
            -f Dockerfile \
            -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --build-arg CONFIG_FILE=config/chat_with_dify.yaml \
            .

      - name: Test complete image
        run: |
          echo "ðŸ§ª æµ‹è¯•é•œåƒåŠŸèƒ½..."
          docker run --rm --entrypoint /bin/bash ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -c "echo 'âœ… OpenAvatarChat AMD64 image works!'"

          echo "ðŸ”§ æµ‹è¯•PythonçŽ¯å¢ƒ..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python --version

          echo "ðŸ”§ æµ‹è¯•uvåŒ…ç®¡ç†å™¨..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} --version

          echo "ðŸ”§ æµ‹è¯•åº”ç”¨æ¨¡å—å¯¼å…¥..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python -c "
          import sys
          sys.path.append('/root/open-avatar-chat/src')
          try:
            print('Testing import...')
            import demo
            print('âœ… åº”ç”¨æ¨¡å—å¯¼å…¥æˆåŠŸ')
          except Exception as e:
            print('âŒ å¯¼å…¥å¤±è´¥:', str(e))
            sys.exit(1)
          "

          echo "ðŸ”§ æµ‹è¯•å…³é”®ä¾èµ–..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python -c "
          try:
            import loguru
            import torch
            import numpy
            print('âœ… å…³é”®ä¾èµ–æ£€æŸ¥é€šè¿‡: loguru, torch, numpy')
          except ImportError as e:
            print('âŒ ä¾èµ–ç¼ºå¤±:', str(e))
            sys.exit(1)
          "

          echo "ðŸ”§ æµ‹è¯•å®¹å™¨åŸºç¡€åŠŸèƒ½..."
          docker run --rm --entrypoint /bin/bash ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -c "
          echo 'ðŸ“ æ£€æŸ¥å·¥ä½œç›®å½•...'
          pwd && ls -la
          echo 'ðŸ“ æ£€æŸ¥è™šæ‹ŸçŽ¯å¢ƒ...'
          ls -la .venv/ | head -10
          echo 'âœ… å®¹å™¨åŸºç¡€åŠŸèƒ½æ­£å¸¸'
          "

      - name: Save complete image
        run: |
          echo "ðŸ’¾ ä¿å­˜é•œåƒä¸ºartifact..."

          # é¦–å…ˆéªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
          echo "ðŸ” æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨..."
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          echo "ðŸ’½ æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ..."
          df -h
          echo "ðŸ’½ å½“å‰ç›®å½•ç£ç›˜ä½¿ç”¨:"
          du -sh . 2>/dev/null || echo "duå‘½ä»¤å¤±è´¥"

          # æ¸…ç†ä¸éœ€è¦çš„Dockeræ•°æ®
          echo "ðŸ§¹ æ¸…ç†Dockerç³»ç»Ÿ..."
          docker system prune -f
          docker image prune -f

          echo "ðŸ’½ æ¸…ç†åŽçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

          # ç›´æŽ¥ç®¡é“åŽ‹ç¼©ï¼Œé¿å…åˆ›å»ºå¤§ä¸´æ—¶æ–‡ä»¶
          echo "ðŸ“¦ åˆ›å»ºå¹¶åŽ‹ç¼©é•œåƒ..."
          docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} | gzip -c > ${{ env.IMAGE_NAME }}-amd64.tar.gz

          # æ£€æŸ¥åŽ‹ç¼©ç»“æžœ
          echo "ðŸ“Š åŽ‹ç¼©åŽå¤§å°:"
          ls -lh ${{ env.IMAGE_NAME }}-amd64.tar.gz

          # å†æ¬¡éªŒè¯é•œåƒä¿¡æ¯
          echo "ðŸ“Š åŽŸå§‹é•œåƒå¤§å°:"
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          # éªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®åˆ›å»º
          echo "âœ… æ–‡ä»¶éªŒè¯:"
          file ${{ env.IMAGE_NAME }}-amd64.tar.gz || echo "fileå‘½ä»¤ä¸å¯ç”¨"
          echo "æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰:"
          stat -c %s ${{ env.IMAGE_NAME }}-amd64.tar.gz 2>/dev/null || wc -c < ${{ env.IMAGE_NAME }}-amd64.tar.gz

          # æœ€ç»ˆç£ç›˜æ£€æŸ¥
          echo "ðŸ’½ æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: Upload complete image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}-amd64
          path: ${{ env.IMAGE_NAME }}-amd64.tar.gz
          retention-days: 7

      - name: Show build summary
        run: |
          echo "âœ… æž„å»ºå®Œæˆ!"
          echo "ðŸ“¦ å®Œæ•´çš„OpenAvatarChat AMD64é•œåƒå·²å‡†å¤‡å¥½ä¸‹è½½"
          echo "ðŸ”§ é•œåƒä¿¡æ¯:"
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo ""
          echo "ðŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "1. åœ¨GitHub Actionsé¡µé¢ä¸‹è½½artifact"
          echo "2. è§£åŽ‹: gunzip ${{ env.IMAGE_NAME }}-amd64.tar.gz"
          echo "3. åŠ è½½: docker load < ${{ env.IMAGE_NAME }}-amd64.tar"
          echo "4. è¿è¡Œ: docker run -it ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo ""
          echo "ðŸ’¡ ä½¿ç”¨æç¤º:"
          echo "- ç¡®ä¿æœ‰GPUçŽ¯å¢ƒä»¥èŽ·å¾—æœ€ä½³æ€§èƒ½"
          echo "- è¿è¡Œæ—¶æŒ‚è½½å¿…è¦çš„ç›®å½•: -v \$(pwd)/config:/root/open-avatar-chat/config"
          echo "- æŸ¥çœ‹README.mdäº†è§£è¯¦ç»†é…ç½®è¯´æ˜Ž"
