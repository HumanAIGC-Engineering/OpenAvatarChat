name: Build OpenAvatarChat AMD64 (Multi-Step)

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/openavatar-chat-complete
  IMAGE_TAG: ${{ github.run_id }}  # ä½¿ç”¨run_idä½œä¸ºå”¯ä¸€æ ‡ç­¾
  FULL_IMAGE_NAME: ghcr.io/${{ github.repository }}/openavatar-chat-complete

jobs:
  build-image:
    name: "ç¬¬ä¸€æ­¥ï¼šæž„å»ºé•œåƒ"
    runs-on: ubuntu-latest  # ä½¿ç”¨AMD64è¿è¡Œå™¨
    timeout-minutes: 480  # 8å°æ—¶è¶…æ—¶
    permissions:
      contents: read
      packages: write  # éœ€è¦å†™æƒé™æ¥æŽ¨é€åŒ…
    outputs:
      image_tag: ${{ env.IMAGE_TAG }}
      full_image_name: ${{ env.FULL_IMAGE_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push OpenAvatarChat image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            CONFIG_FILE=config/chat_with_dify.yaml
          push: true
          tags: ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.description=OpenAvatarChat Complete Image
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test pushed image
        run: |
          echo "ðŸ§ª æµ‹è¯•æŽ¨é€çš„é•œåƒåŠŸèƒ½..."

          # æ‹‰å–åˆšåˆšæŽ¨é€çš„é•œåƒ
          echo "ðŸ“¥ æ‹‰å–é•œåƒè¿›è¡Œæµ‹è¯•..."
          docker pull ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          # ä½¿ç”¨æœ¬åœ°é•œåƒè¿›è¡Œæµ‹è¯•
          docker run --rm --entrypoint /bin/bash ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }} -c "echo 'âœ… OpenAvatarChat AMD64 image works!'"

          echo "ðŸ”§ æµ‹è¯•PythonçŽ¯å¢ƒ..."
          docker run --rm --entrypoint uv ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python --version

          echo "ðŸ”§ æµ‹è¯•uvåŒ…ç®¡ç†å™¨..."
          docker run --rm --entrypoint uv ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }} --version

          echo "ðŸ”§ æµ‹è¯•åº”ç”¨æ¨¡å—å¯¼å…¥..."
          docker run --rm --entrypoint uv ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python -c "
          import sys
          sys.path.append('/root/open-avatar-chat/src')
          try:
            print('Testing import...')
            import demo
            print('âœ… åº”ç”¨æ¨¡å—å¯¼å…¥æˆåŠŸ')
          except Exception as e:
            print('âŒ å¯¼å…¥å¤±è´¥:', str(e))
            sys.exit(1)
          "

          echo "ðŸ”§ æµ‹è¯•å…³é”®ä¾èµ–..."
          docker run --rm --entrypoint uv ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python -c "
          try:
            import loguru
            import torch
            import numpy
            print('âœ… å…³é”®ä¾èµ–æ£€æŸ¥é€šè¿‡: loguru, torch, numpy')
          except ImportError as e:
            print('âŒ ä¾èµ–ç¼ºå¤±:', str(e))
            sys.exit(1)
          "

          echo "ðŸ”§ æµ‹è¯•å®¹å™¨åŸºç¡€åŠŸèƒ½..."
          docker run --rm --entrypoint /bin/bash ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }} -c "
          echo 'ðŸ“ æ£€æŸ¥å·¥ä½œç›®å½•...'
          pwd && ls -la | head -10
          echo 'âœ… å®¹å™¨åŸºç¡€åŠŸèƒ½æ­£å¸¸'
          "

          echo "âœ… ç¬¬ä¸€æ­¥æµ‹è¯•å®Œæˆï¼Œé•œåƒå·²æŽ¨é€è‡³: ${{ env.FULL_IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

  compress-image:
    name: "ç¬¬äºŒæ­¥ï¼šåŽ‹ç¼©é•œåƒ"
    runs-on: ubuntu-latest
    needs: build-image  # ä¾èµ–ç¬¬ä¸€æ­¥å®Œæˆ
    timeout-minutes: 180  # 3å°æ—¶è¶…æ—¶

    steps:
      - name: Pull image from registry
        run: |
          echo "ðŸ“¥ ä»Žregistryæ‹‰å–é•œåƒ..."

          # ä»Žç¬¬ä¸€æ­¥èŽ·å–é•œåƒä¿¡æ¯
          IMAGE_TAG=${{ needs.build-image.outputs.image_tag }}
          FULL_IMAGE_NAME=${{ needs.build-image.outputs.full_image_name }}

          echo "ðŸ” æ‹‰å–é•œåƒ: $FULL_IMAGE_NAME:$IMAGE_TAG"
          docker pull $FULL_IMAGE_NAME:$IMAGE_TAG

          # éªŒè¯é•œåƒ
          echo "ðŸ“Š æ‹‰å–çš„é•œåƒä¿¡æ¯:"
          docker images $FULL_IMAGE_NAME:$IMAGE_TAG

      - name: Compress image with XZ
        run: |
          echo "ðŸ—œï¸ å¼€å§‹åŽ‹ç¼©é•œåƒ..."

          # èŽ·å–é•œåƒä¿¡æ¯
          IMAGE_TAG=${{ needs.build-image.outputs.image_tag }}
          FULL_IMAGE_NAME=${{ needs.build-image.outputs.full_image_name }}

          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          echo "ðŸ’½ å½“å‰ç£ç›˜ç©ºé—´:"
          df -h

          # å¯¼å‡ºé•œåƒä¸ºtar
          echo "ðŸ“¦ å¯¼å‡ºé•œåƒä¸ºtaræ–‡ä»¶..."
          docker save $FULL_IMAGE_NAME:$IMAGE_TAG > openavatar-chat-complete-amd64.tar

          # éªŒè¯taræ–‡ä»¶
          echo "ðŸ“Š taræ–‡ä»¶å¤§å°:"
          ls -lh openavatar-chat-complete-amd64.tar
          TAR_SIZE=$(stat -c %s openavatar-chat-complete-amd64.tar 2>/dev/null || wc -c < openavatar-chat-complete-amd64.tar)
          echo "taræ–‡ä»¶å¤§å°: $TAR_SIZE å­—èŠ‚"

          if [ "$TAR_SIZE" -lt 1000000000 ]; then  # å°äºŽ1GB
            echo "âŒ taræ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æœ‰é—®é¢˜: $TAR_SIZE å­—èŠ‚"
            exit 1
          fi

          # å®‰è£…XZå·¥å…·
          echo "ðŸ”§ å®‰è£…XZåŽ‹ç¼©å·¥å…·..."
          sudo apt-get update && sudo apt-get install -y xz-utils

          # ä½¿ç”¨XZåŽ‹ç¼© (å¤šçº¿ç¨‹ï¼Œæœ€é«˜åŽ‹ç¼©çŽ‡)
          echo "ðŸ“¦ åŽ‹ç¼©ä¸­ (è¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´)..."
          xz -T0 -9 openavatar-chat-complete-amd64.tar

          # æ£€æŸ¥åŽ‹ç¼©ç»“æžœ
          echo "ðŸ“Š åŽ‹ç¼©åŽå¤§å°:"
          ls -lh openavatar-chat-complete-amd64.tar.xz

          XZ_SIZE=$(stat -c %s openavatar-chat-complete-amd64.tar.xz 2>/dev/null || wc -c < openavatar-chat-complete-amd64.tar.xz)
          echo "åŽ‹ç¼©æ–‡ä»¶å¤§å°: $XZ_SIZE å­—èŠ‚"

          if [ "$XZ_SIZE" -lt 100000000 ]; then  # å°äºŽ100MB
            echo "âŒ åŽ‹ç¼©æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æœ‰é—®é¢˜: $XZ_SIZE å­—èŠ‚"
            exit 1
          fi

          # æ˜¾ç¤ºåŽ‹ç¼©çŽ‡
          COMPRESSION_RATIO=$((TAR_SIZE * 100 / XZ_SIZE))
          echo "ðŸ“Š åŽ‹ç¼©çŽ‡: çº¦ ${COMPRESSION_RATIO}% (XZæ ¼å¼)"

          echo "âœ… åŽ‹ç¼©å®Œæˆ"

      - name: Upload compressed image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}-amd64
          path: ${{ env.IMAGE_NAME }}-amd64.tar.xz
          retention-days: 7

      - name: Show final build summary
        run: |
          echo "ðŸŽ‰ å®Œæ•´æž„å»ºæµç¨‹å®Œæˆ!"
          echo "ðŸ“¦ OpenAvatarChat AMD64é•œåƒå·²åŽ‹ç¼©å¹¶å‡†å¤‡ä¸‹è½½"
          echo ""
          echo "ðŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "1. åœ¨GitHub Actionsé¡µé¢æ‰¾åˆ° '${{ env.IMAGE_NAME }}-amd64' artifact"
          echo "2. ä¸‹è½½åŽ‹ç¼©æ–‡ä»¶: ${{ env.IMAGE_NAME }}-amd64.tar.xz"
          echo "3. è§£åŽ‹: xz -d ${{ env.IMAGE_NAME }}-amd64.tar.xz"
          echo "4. åŠ è½½é•œåƒ: docker load < ${{ env.IMAGE_NAME }}-amd64.tar"
          echo "5. è¿è¡Œ: docker run -it ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo ""
          echo "ðŸ’¡ ä½¿ç”¨æç¤º:"
          echo "- ç¡®ä¿æœ‰GPUçŽ¯å¢ƒä»¥èŽ·å¾—æœ€ä½³æ€§èƒ½"
          echo "- è¿è¡Œæ—¶æŒ‚è½½é…ç½®ç›®å½•: -v \$(pwd)/config:/root/open-avatar-chat/config"
          echo "- æŸ¥çœ‹README.mdäº†è§£è¯¦ç»†é…ç½®è¯´æ˜Ž"
          echo ""
          echo "ðŸ“Š æž„å»ºç»Ÿè®¡:"
          echo "- ç¬¬ä¸€æ­¥ï¼šé•œåƒæž„å»ºå’Œæµ‹è¯• âœ…"
          echo "- ç¬¬äºŒæ­¥ï¼šé•œåƒåŽ‹ç¼©å’Œæ‰“åŒ… âœ…"
