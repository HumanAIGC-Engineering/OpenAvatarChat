name: Build OpenAvatarChat AMD64 (Complete)

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  IMAGE_NAME: openavatar-chat-complete
  IMAGE_TAG: latest

jobs:
  build-complete:
    runs-on: ubuntu-latest  # ä½¿ç”¨AMD64è¿è¡Œå™¨
    timeout-minutes: 480  # 8å°æ—¶è¶…æ—¶
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build complete OpenAvatarChat image
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºå®Œæ•´çš„OpenAvatarChat ARM64é•œåƒ..."
          docker build \
            -f Dockerfile \
            -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --build-arg CONFIG_FILE=config/chat_with_dify.yaml \
            .

      - name: Test complete image
        run: |
          echo "ğŸ§ª æµ‹è¯•é•œåƒåŠŸèƒ½..."
          docker run --rm --entrypoint /bin/bash ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -c "echo 'âœ… OpenAvatarChat AMD64 image works!'"

          echo "ğŸ”§ æµ‹è¯•Pythonç¯å¢ƒ..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python --version

          echo "ğŸ”§ æµ‹è¯•uvåŒ…ç®¡ç†å™¨..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} --version

          echo "ğŸ”§ æµ‹è¯•åº”ç”¨æ¨¡å—å¯¼å…¥..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python -c "
          import sys
          sys.path.append('/root/open-avatar-chat/src')
          try:
            print('Testing import...')
            import demo
            print('âœ… åº”ç”¨æ¨¡å—å¯¼å…¥æˆåŠŸ')
          except Exception as e:
            print('âŒ å¯¼å…¥å¤±è´¥:', str(e))
            sys.exit(1)
          "

          echo "ğŸ”§ æµ‹è¯•å…³é”®ä¾èµ–..."
          docker run --rm --entrypoint uv ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} run python -c "
          try:
            import loguru
            import torch
            import numpy
            print('âœ… å…³é”®ä¾èµ–æ£€æŸ¥é€šè¿‡: loguru, torch, numpy')
          except ImportError as e:
            print('âŒ ä¾èµ–ç¼ºå¤±:', str(e))
            sys.exit(1)
          "

          echo "ğŸ”§ æµ‹è¯•å®¹å™¨åŸºç¡€åŠŸèƒ½..."
          docker run --rm --entrypoint /bin/bash ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -c "
          echo 'ğŸ“ æ£€æŸ¥å·¥ä½œç›®å½•...'
          pwd && ls -la
          echo 'ğŸ“ æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ...'
          ls -la .venv/ | head -10
          echo 'âœ… å®¹å™¨åŸºç¡€åŠŸèƒ½æ­£å¸¸'
          "

      - name: Save complete image
        run: |
          echo "ğŸ’¾ ä¿å­˜é•œåƒä¸ºartifact..."

          # é¦–å…ˆéªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨..."
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          echo "ğŸ’½ æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ..."
          df -h
          echo "ğŸ’½ å½“å‰ç›®å½•ç£ç›˜ä½¿ç”¨:"
          du -sh . 2>/dev/null || echo "duå‘½ä»¤å¤±è´¥"

          # æ¸…ç†ä¸éœ€è¦çš„Dockeræ•°æ®
          echo "ğŸ§¹ æ¸…ç†Dockerç³»ç»Ÿ..."
          docker system prune -f
          docker image prune -f

          echo "ğŸ’½ æ¸…ç†åçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

          # ç›´æ¥ç®¡é“å‹ç¼©ï¼Œé¿å…åˆ›å»ºå¤§ä¸´æ—¶æ–‡ä»¶
          echo "ğŸ“¦ åˆ›å»ºå¹¶å‹ç¼©é•œåƒ..."
          set -o pipefail  # ç®¡é“ä¸­ä»»ä¸€å‘½ä»¤å¤±è´¥åˆ™é€€å‡º
          if docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} | gzip -c > ${{ env.IMAGE_NAME }}-amd64.tar.gz; then
            echo "âœ… å‹ç¼©å®Œæˆ"
          else
            echo "âŒ å‹ç¼©å¤±è´¥ï¼Œæ£€æŸ¥é”™è¯¯"
            echo "æ£€æŸ¥docker saveæ˜¯å¦æ­£å¸¸å·¥ä½œ..."
            docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} > /tmp/test.tar 2>&1 || echo "docker save å¤±è´¥"
            ls -lh /tmp/test.tar 2>/dev/null || echo "test.tarä¸å­˜åœ¨"
            exit 1
          fi

          # æ£€æŸ¥å‹ç¼©ç»“æœ
          echo "ğŸ“Š å‹ç¼©åå¤§å°:"
          ls -lh ${{ env.IMAGE_NAME }}-amd64.tar.gz

          # æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦åˆç†ï¼ˆè‡³å°‘åº”è¯¥æœ‰å‡ MBï¼‰
          FILE_SIZE=$(stat -c %s ${{ env.IMAGE_NAME }}-amd64.tar.gz 2>/dev/null || wc -c < ${{ env.IMAGE_NAME }}-amd64.tar.gz)
          if [ "$FILE_SIZE" -lt 1000000 ]; then  # å°äº1MB
            echo "âŒ æ–‡ä»¶å¤§å°å¼‚å¸¸: $FILE_SIZE å­—èŠ‚"
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "æ£€æŸ¥æ–‡ä»¶å†…å®¹:"
            head -c 200 ${{ env.IMAGE_NAME }}-amd64.tar.gz | od -c || echo "æ— æ³•è¯»å–æ–‡ä»¶"
            echo "æ£€æŸ¥gzipæ˜¯å¦å®‰è£…:"
            which gzip || echo "gzipæœªæ‰¾åˆ°"
            gzip --version 2>/dev/null | head -1 || echo "gzipç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
            echo "æ£€æŸ¥ç£ç›˜ç©ºé—´:"
            df -h .
            exit 1
          else
            echo "âœ… æ–‡ä»¶å¤§å°æ­£å¸¸: $FILE_SIZE å­—èŠ‚"
          fi

          # å†æ¬¡éªŒè¯é•œåƒä¿¡æ¯
          echo "ğŸ“Š åŸå§‹é•œåƒå¤§å°:"
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          # éªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®åˆ›å»º
          echo "âœ… æ–‡ä»¶éªŒè¯:"
          file ${{ env.IMAGE_NAME }}-amd64.tar.gz 2>/dev/null || echo "fileå‘½ä»¤ä¸å¯ç”¨"

          # æœ€ç»ˆç£ç›˜æ£€æŸ¥
          echo "ğŸ’½ æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: Upload complete image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}-amd64
          path: ${{ env.IMAGE_NAME }}-amd64.tar.gz
          retention-days: 7

      - name: Show build summary
        run: |
          echo "âœ… æ„å»ºå®Œæˆ!"
          echo "ğŸ“¦ å®Œæ•´çš„OpenAvatarChat AMD64é•œåƒå·²å‡†å¤‡å¥½ä¸‹è½½"
          echo "ğŸ”§ é•œåƒä¿¡æ¯:"
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo ""
          echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "1. åœ¨GitHub Actionsé¡µé¢ä¸‹è½½artifact"
          echo "2. è§£å‹: gunzip ${{ env.IMAGE_NAME }}-amd64.tar.gz"
          echo "3. åŠ è½½: docker load < ${{ env.IMAGE_NAME }}-amd64.tar"
          echo "4. è¿è¡Œ: docker run -it ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo ""
          echo "ğŸ’¡ ä½¿ç”¨æç¤º:"
          echo "- ç¡®ä¿æœ‰GPUç¯å¢ƒä»¥è·å¾—æœ€ä½³æ€§èƒ½"
          echo "- è¿è¡Œæ—¶æŒ‚è½½å¿…è¦çš„ç›®å½•: -v \$(pwd)/config:/root/open-avatar-chat/config"
          echo "- æŸ¥çœ‹README.mdäº†è§£è¯¦ç»†é…ç½®è¯´æ˜"
