name: Build OpenAvatarChat AMD64 (Complete)

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  IMAGE_NAME: openavatar-chat-complete
  IMAGE_TAG: latest

jobs:
  build-complete:
    runs-on: ubuntu-latest  # ä½¿ç”¨AMD64è¿è¡Œå™¨
    timeout-minutes: 480  # 8å°æ—¶è¶…æ—¶
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build complete OpenAvatarChat image
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºå®Œæ•´çš„OpenAvatarChat ARM64é•œåƒ..."
          docker build \
            -f Dockerfile \
            -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --build-arg CONFIG_FILE=config/chat_with_dify.yaml \
            .

      - name: Test complete image
        run: |
          echo "ğŸ§ª æµ‹è¯•é•œåƒåŠŸèƒ½..."
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} echo "âœ… OpenAvatarChat ARM64 image works!"

          echo "ğŸ”§ æµ‹è¯•Pythonç¯å¢ƒ..."
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} python3 -c "import sys; print('Python version:', sys.version)"

          echo "ğŸ”§ æµ‹è¯•uvåŒ…ç®¡ç†å™¨..."
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} uv --version

          echo "ğŸ”§ æµ‹è¯•åº”ç”¨æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨..."
          timeout 30s docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} python3 -c "
          import sys
          sys.path.append('/root/open-avatar-chat/src')
          try:
            print('Testing import...')
            from demo import *
            print('âœ… åº”ç”¨æ¨¡å—å¯¼å…¥æˆåŠŸ')
          except Exception as e:
            print('âŒ å¯¼å…¥å¤±è´¥:', str(e))
            sys.exit(1)
          " || echo "âš ï¸  åº”ç”¨å¯åŠ¨æµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºåº”ç”¨éœ€è¦æ›´å¤šé…ç½®"

      - name: Save complete image
        run: |
          echo "ğŸ’¾ ä¿å­˜é•œåƒä¸ºartifact..."

          # é¦–å…ˆéªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨..."
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          # åˆ›å»ºä¸´æ—¶taræ–‡ä»¶ï¼Œç„¶åå‹ç¼©
          echo "ğŸ“¦ åˆ›å»ºtaræ–‡ä»¶..."
          docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} > temp_image.tar

          echo "ğŸ—œï¸  å‹ç¼©é•œåƒ..."
          gzip temp_image.tar

          # ç§»åŠ¨åˆ°æœ€ç»ˆæ–‡ä»¶å
          mv temp_image.tar.gz ${{ env.IMAGE_NAME }}-amd64.tar.gz

          echo "ğŸ“Š å‹ç¼©åå¤§å°:"
          ls -lh ${{ env.IMAGE_NAME }}-amd64.tar.gz

          # å†æ¬¡éªŒè¯é•œåƒä¿¡æ¯
          echo "ğŸ“Š åŸå§‹é•œåƒå¤§å°:"
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          # éªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®åˆ›å»º
          echo "âœ… æ–‡ä»¶éªŒè¯:"
          file ${{ env.IMAGE_NAME }}-amd64.tar.gz
          echo "æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰:"
          stat -c %s ${{ env.IMAGE_NAME }}-amd64.tar.gz

      - name: Upload complete image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}-amd64
          path: ${{ env.IMAGE_NAME }}-amd64.tar.gz
          retention-days: 7

      - name: Show build summary
        run: |
          echo "âœ… æ„å»ºå®Œæˆ!"
          echo "ğŸ“¦ å®Œæ•´çš„OpenAvatarChat AMD64é•œåƒå·²å‡†å¤‡å¥½ä¸‹è½½"
          echo "ğŸ”§ é•œåƒä¿¡æ¯:"
          docker images ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo ""
          echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "1. åœ¨GitHub Actionsé¡µé¢ä¸‹è½½artifact"
          echo "2. è§£å‹: gunzip ${{ env.IMAGE_NAME }}-amd64.tar.gz"
          echo "3. åŠ è½½: docker load < ${{ env.IMAGE_NAME }}-amd64.tar"
          echo "4. è¿è¡Œ: docker run -it ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo ""
          echo "ğŸ’¡ ä½¿ç”¨æç¤º:"
          echo "- ç¡®ä¿æœ‰GPUç¯å¢ƒä»¥è·å¾—æœ€ä½³æ€§èƒ½"
          echo "- è¿è¡Œæ—¶æŒ‚è½½å¿…è¦çš„ç›®å½•: -v \$(pwd)/config:/root/open-avatar-chat/config"
          echo "- æŸ¥çœ‹README.mdäº†è§£è¯¦ç»†é…ç½®è¯´æ˜"
